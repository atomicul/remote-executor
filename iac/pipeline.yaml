AWSTemplateFormatVersion: '2010-09-09'
Description: '100% Complete CI/CD PoC: CodePipeline + EC2 Image Builder for Remote Executor'

Parameters:
  RepositoryName:
    Type: String
    Description: The name of the GitHub/Bitbucket repository (e.g., my-org/remote-executor).
  BranchName:
    Type: String
    Default: main
    Description: The branch to build from.
  CodeStarConnectionArn:
    Type: String
    Description: The ARN of the AWS CodeStar Connection to your Git provider.

Resources:
  # ---------------------------------------------------------
  # 1. STORAGE
  # ---------------------------------------------------------
  ArtifactBucket:
    Type: AWS::S3::Bucket
    Properties:
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  # ---------------------------------------------------------
  # 2. EC2 IMAGE BUILDER RESOURCES
  # ---------------------------------------------------------
  ImageBuilderInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/EC2InstanceProfileForImageBuilder
      Policies:
        - PolicyName: S3ArtifactAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: !Sub '${ArtifactBucket.Arn}/*'
        - PolicyName: SidecarDynamoDbAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                Resource: !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/RemoteExecutor-JobState'

  ImageBuilderInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref ImageBuilderInstanceRole

  ImageBuilderInfraConfig:
    Type: AWS::ImageBuilder::InfrastructureConfiguration
    Properties:
      Name: remote-executor-infra
      InstanceProfileName: !Ref ImageBuilderInstanceProfile

  ImageBuilderComponent:
    Type: AWS::ImageBuilder::Component
    Properties:
      Name: remote-executor-setup
      Platform: Linux
      Version: '1.0.0'
      # The component YAML is embedded directly as a string here!
      Data: !Sub |
        name: RemoteExecutorSetup
        description: Installs Java 21, Docker, and the Remote Executor
        schemaVersion: 1.0
        phases:
          - name: build
            steps:
              - name: InstallDependencies
                action: ExecuteBash
                inputs:
                  commands:
                    - dnf update -y
                    - dnf install -y java-21-amazon-corretto docker
                    - systemctl enable docker
                    - systemctl start docker
              - name: DownloadAppArchive
                action: S3Download
                inputs:
                  - source: s3://${ArtifactBucket}/remote-executor/server.tar
                    destination: /opt/server.tar
              - name: ExtractApp
                action: ExecuteBash
                inputs:
                  commands:
                    - cd /opt
                    - tar -xvf server.tar
                    - chmod +x /opt/server/bin/server
              - name: ConfigureSystemd
                action: ExecuteBash
                inputs:
                  commands:
                    - |
                      cat << 'EOF' > /etc/systemd/system/remote-executor.service
                      [Unit]
                      Description=Remote Shell Executor Service
                      After=docker.service
                      Requires=docker.service

                      [Service]
                      ExecStart=/opt/server/bin/server
                      Restart=always
                      User=root 

                      [Install]
                      WantedBy=multi-user.target
                      EOF
                    - systemctl enable remote-executor.service

  ImageBuilderRecipe:
    Type: AWS::ImageBuilder::ImageRecipe
    Properties:
      Name: remote-executor-recipe
      Version: '1.0.0'
      # Automatically pulls the latest Amazon Linux 2023 provided by AWS
      ParentImage: !Sub 'arn:aws:imagebuilder:${AWS::Region}:aws:image/amazon-linux-2023-x86/x.x.x'
      Components:
        - ComponentArn: !GetAtt ImageBuilderComponent.Arn

  ImagePipeline:
    Type: AWS::ImageBuilder::ImagePipeline
    Properties:
      Name: remote-executor-pipeline
      ImageRecipeArn: !GetAtt ImageBuilderRecipe.Arn
      InfrastructureConfigurationArn: !GetAtt ImageBuilderInfraConfig.Arn

  # ---------------------------------------------------------
  # 2b. SIDECAR IMAGE BUILDER RESOURCES (Layered on Server AMI)
  # ---------------------------------------------------------
  SidecarImageBuilderComponent:
    Type: AWS::ImageBuilder::Component
    Properties:
      Name: remote-executor-sidecar-setup
      Platform: Linux
      Version: '1.0.0'
      Data: !Sub |
        name: RemoteExecutorSidecarSetup
        description: Installs the Remote Executor Sidecar and its systemd unit
        schemaVersion: 1.0
        phases:
          - name: build
            steps:
              - name: DownloadSidecarArchive
                action: S3Download
                inputs:
                  - source: s3://${ArtifactBucket}/remote-executor/sidecar.tar
                    destination: /opt/sidecar.tar
              - name: ExtractSidecar
                action: ExecuteBash
                inputs:
                  commands:
                    - cd /opt
                    - tar -xvf sidecar.tar
                    - chmod +x /opt/sidecar/bin/sidecar
              - name: CreateInstanceIdScript
                action: ExecuteBash
                inputs:
                  commands:
                    - |
                      cat << 'SCRIPT' > /opt/sidecar/bin/fetch-instance-id.sh
                      #!/bin/bash
                      mkdir -p /run/sidecar
                      TOKEN=$(curl -sf -X PUT "http://169.254.169.254/latest/api/token" \
                        -H "X-aws-ec2-metadata-token-ttl-seconds: 60")
                      INSTANCE_ID=$(curl -sf \
                        -H "X-aws-ec2-metadata-token: $TOKEN" \
                        http://169.254.169.254/latest/meta-data/instance-id)
                      echo "INSTANCE_ID=$INSTANCE_ID" > /run/sidecar/instance-id.env
                      SCRIPT
                    - chmod +x /opt/sidecar/bin/fetch-instance-id.sh
              - name: ConfigureSystemd
                action: ExecuteBash
                inputs:
                  commands:
                    - |
                      cat << 'EOF' > /etc/systemd/system/remote-executor-sidecar.service
                      [Unit]
                      Description=Remote Executor Sidecar
                      After=remote-executor.service
                      Requires=remote-executor.service

                      [Service]
                      ExecStartPre=/opt/sidecar/bin/fetch-instance-id.sh
                      EnvironmentFile=/run/sidecar/instance-id.env
                      ExecStart=/opt/sidecar/bin/sidecar localhost:9090
                      Restart=always
                      User=root

                      [Install]
                      WantedBy=multi-user.target
                      EOF
                    - systemctl enable remote-executor-sidecar.service

  SidecarImageBuilderRecipe:
    Type: AWS::ImageBuilder::ImageRecipe
    Properties:
      Name: remote-executor-sidecar-recipe
      Version: '1.0.0'
      ParentImage: !Sub 'arn:aws:imagebuilder:${AWS::Region}:${AWS::AccountId}:image/remote-executor-recipe/x.x.x'
      Components:
        - ComponentArn: !GetAtt SidecarImageBuilderComponent.Arn

  SidecarImagePipeline:
    Type: AWS::ImageBuilder::ImagePipeline
    Properties:
      Name: remote-executor-sidecar-pipeline
      ImageRecipeArn: !GetAtt SidecarImageBuilderRecipe.Arn
      InfrastructureConfigurationArn: !GetAtt ImageBuilderInfraConfig.Arn

  # ---------------------------------------------------------
  # 3. CI/CD RESOURCES
  # ---------------------------------------------------------
  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CodeBuildBasePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:GetObjectVersion
                Resource: !Sub '${ArtifactBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - imagebuilder:StartImagePipelineExecution
                Resource:
                  - !Ref ImagePipeline
                  - !Ref SidecarImagePipeline
              - Effect: Allow
                Action:
                  - imagebuilder:ListImagePipelineImages
                Resource: !Ref ImagePipeline
              - Effect: Allow
                Action:
                  - imagebuilder:GetImage
                Resource: !Sub 'arn:aws:imagebuilder:${AWS::Region}:${AWS::AccountId}:image/remote-executor-recipe/*'

  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: remote-executor-build 
      ServiceRole: !GetAtt CodeBuildRole.Arn
      ConcurrentBuildLimit: 1 
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:5.0
        EnvironmentVariables:
          - Name: ARTIFACT_BUCKET
            Value: !Ref ArtifactBucket
          - Name: PIPELINE_ARN
            Value: !Ref ImagePipeline 
      Source:
        Type: CODEPIPELINE
        BuildSpec: server/buildspec.yml

  SidecarCodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: remote-executor-sidecar-build
      ServiceRole: !GetAtt CodeBuildRole.Arn
      ConcurrentBuildLimit: 1
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:5.0
        EnvironmentVariables:
          - Name: ARTIFACT_BUCKET
            Value: !Ref ArtifactBucket
          - Name: PIPELINE_ARN
            Value: !Ref SidecarImagePipeline
          - Name: SERVER_PIPELINE_ARN
            Value: !Ref ImagePipeline
      Source:
        Type: CODEPIPELINE
        BuildSpec: sidecar/buildspec.yml

  CodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codepipeline.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CodePipelinePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                Resource: !Sub '${ArtifactBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - codebuild:BatchGetBuilds
                  - codebuild:StartBuild
                Resource:
                  - !GetAtt CodeBuildProject.Arn
                  - !GetAtt SidecarCodeBuildProject.Arn
              - Effect: Allow
                Action:
                  - codestar-connections:UseConnection
                Resource: !Ref CodeStarConnectionArn

  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: remote-executor-pipeline 
      RoleArn: !GetAtt CodePipelineRole.Arn
      ArtifactStore:
        Type: S3
        Location: !Ref ArtifactBucket
      Stages:
        - Name: Source
          Actions:
            - Name: SourceAction
              ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: CodeStarSourceConnection
                Version: '1'
              OutputArtifacts:
                - Name: SourceArtifact
              Configuration:
                ConnectionArn: !Ref CodeStarConnectionArn
                FullRepositoryId: !Ref RepositoryName
                BranchName: !Ref BranchName
        - Name: BuildServer
          Actions:
            - Name: BuildServerAction
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              InputArtifacts:
                - Name: SourceArtifact
              Configuration:
                ProjectName: !Ref CodeBuildProject
        - Name: BuildSidecar
          Actions:
            - Name: BuildSidecarAction
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              InputArtifacts:
                - Name: SourceArtifact
              Configuration:
                ProjectName: !Ref SidecarCodeBuildProject

Outputs:
  ArtifactBucketName:
    Value: !Ref ArtifactBucket
